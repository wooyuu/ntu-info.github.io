<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neurosynth Term Explorer</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Alpine.js for reactivity -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    [x-cloak] { display: none !important; }
    
    .gradient-bg {
      background: linear-gradient(135deg, #274046 0%, #E6DADA 100%);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    
    .pulse-slow {
      animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Loading Skeleton Animation */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }
    
    .skeleton {
      animation: shimmer 2s infinite linear;
      background: linear-gradient(to right, #f0f0f0 4%, #e0e0e0 25%, #f0f0f0 36%);
      background-size: 1000px 100%;
    }
    
    /* Line clamp for text truncation */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="neurosynthApp()">
  
  <!-- Header -->
  <header class="gradient-bg text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-brain text-4xl"></i>
          <div>
            <h1 class="text-3xl font-bold">Neurosynth Explorer</h1>
            <p class="text-blue-100 text-sm">ç¥ç¶“ç§‘å­¸æ–‡ç»è³‡æ–™åº«</p>
          </div>
        </div>
        <div class="text-right text-sm">
          <p>API: <code class="bg-white/20 px-2 py-1 rounded">hpc.psy.ntu.edu.tw</code></p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Tab Navigation -->
    <div class="bg-white rounded-lg shadow-md mb-6 overflow-hidden">
      <div class="flex border-b">
        <button 
          @click="activeTab = 'terms'"
          :class="activeTab === 'terms' ? 'bg-slate-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
          class="flex-1 py-4 px-6 font-semibold transition-colors duration-200 flex items-center justify-center space-x-2">
          <i class="fas fa-list"></i>
          <span>æ‰€æœ‰ Terms</span>
        </button>
        
        <button 
          @click="activeTab = 'lookup'"
          :class="activeTab === 'lookup' ? 'bg-slate-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
          class="flex-1 py-4 px-6 font-semibold transition-colors duration-200 flex items-center justify-center space-x-2">
          <i class="fas fa-search"></i>
          <span>Term æŸ¥è©¢</span>
        </button>
        
        <button 
          @click="activeTab = 'query'"
          :class="activeTab === 'query' ? 'bg-slate-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
          class="flex-1 py-4 px-6 font-semibold transition-colors duration-200 flex items-center justify-center space-x-2">
          <i class="fas fa-project-diagram"></i>
          <span>é‚è¼¯æœå°‹</span>
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="space-y-6">
      
      <!-- Tab 1: All Terms -->
      <div x-show="activeTab === 'terms'" x-cloak class="slide-in">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
              <i class="fas fa-database mr-2 text-yellow-600"></i>
              æ‰€æœ‰å¯ç”¨çš„ Terms
            </h2>
            <button 
              @click="fetchAllTerms()" 
              :disabled="loading"
              class="bg-slate-500 hover:bg-slate-600 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
              <i class="fas" :class="loading ? 'fa-spinner fa-spin' : 'fa-sync'"></i>
              <span x-text="loading ? 'è¼‰å…¥ä¸­...' : 'é‡æ–°è¼‰å…¥'"></span>
            </button>
          </div>
          
          <!-- Search Filter -->
          <div class="mb-4">
            <input 
              type="text" 
              x-model="termFilter"
              @input="currentPage = 1"
              placeholder="ğŸ” æœå°‹ term..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600 focus:border-transparent">
          </div>
          
          <!-- Results -->
          <div x-show="error" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span x-text="error"></span>
          </div>
          
          <!-- Loading Skeleton -->
          <div x-show="loading" class="space-y-2">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <template x-for="i in 12" :key="i">
                <div class="skeleton h-16 rounded-lg"></div>
              </template>
            </div>
          </div>
          
          <!-- Terms List with Pagination -->
          <div x-show="!loading && allTerms.length > 0" class="space-y-4">
            <!-- Stats -->
            <div class="flex items-center justify-between text-sm text-gray-600">
              <p>
                é¡¯ç¤ºç¬¬ <span class="font-bold text-yellow-600" x-text="(currentPage - 1) * itemsPerPage + 1"></span> 
                åˆ° <span class="font-bold text-yellow-600" x-text="Math.min(currentPage * itemsPerPage, filteredTerms.length)"></span> 
                ç­†ï¼Œå…± <span class="font-bold text-yellow-600" x-text="filteredTerms.length"></span> å€‹ terms
              </p>
              
              <!-- Items per page selector -->
              <div class="flex items-center space-x-2">
                <label>æ¯é é¡¯ç¤º:</label>
                <select 
                  x-model.number="itemsPerPage"
                  @change="currentPage = 1"
                  class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-yellow-600">
                  <option value="12">12</option>
                  <option value="24">24</option>
                  <option value="48">48</option>
                  <option value="96">96</option>
                </select>
              </div>
            </div>
            
            <!-- Terms Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <template x-for="term in paginatedTerms" :key="term">
                <button
                  @click="lookupTerm(term)"
                  class="text-left px-4 py-3 bg-gray-50 hover:bg-yellow-50 border border-gray-200 hover:border-yellow-300 rounded-lg transition-all duration-200 card-hover">
                  <i class="fas fa-tag text-yellow-600 mr-2"></i>
                  <span class="text-gray-800 font-medium" x-text="term"></span>
                </button>
              </template>
            </div>
            
            <!-- Pagination Controls -->
            <div class="flex items-center justify-center space-x-2 pt-4" x-show="totalPages > 1">
              <button @click="currentPage = 1" :disabled="currentPage === 1" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                <i class="fas fa-angle-double-left"></i>
              </button>
              <button @click="currentPage--" :disabled="currentPage === 1" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                <i class="fas fa-angle-left"></i>
              </button>
              <template x-for="page in pageNumbers" :key="page">
                <button @click="currentPage = page" :class="currentPage === page ? 'bg-yellow-600 text-white' : 'bg-white hover:bg-gray-100'" class="px-4 py-2 rounded-lg border border-gray-300 transition-colors font-medium" x-text="page"></button>
              </template>
              <button @click="currentPage++" :disabled="currentPage === totalPages" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                <i class="fas fa-angle-right"></i>
              </button>
              <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                <i class="fas fa-angle-double-right"></i>
              </button>
            </div>
            
            <!-- Quick Jump -->
            <div class="flex items-center justify-center space-x-2 text-sm" x-show="totalPages > 1">
              <span class="text-gray-600">è·³åˆ°ç¬¬</span>
              <input type="number" x-model.number="jumpToPage" @keyup.enter="goToPage()" min="1" :max="totalPages" class="w-16 px-2 py-1 border border-gray-300 rounded text-center focus:ring-2 focus:ring-yellow-600">
              <span class="text-gray-600">é </span>
              <button @click="goToPage()" class="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition-colors">å‰å¾€</button>
            </div>
          </div>
          
          <div x-show="!loading && allTerms.length === 0" class="text-center py-12 text-gray-500">
            <i class="fas fa-inbox text-6xl mb-4"></i>
            <p>é»æ“Šã€Œé‡æ–°è¼‰å…¥ã€ä¾†å–å¾—è³‡æ–™</p>
          </div>
        </div>
      </div>

      <!-- Tab 2: Term Lookup -->
      <div x-show="activeTab === 'lookup'" x-cloak class="slide-in">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-search mr-2 text-yellow-600"></i>
            æŸ¥è©¢ç‰¹å®š Term
          </h2>
          
          <div class="flex space-x-2 mb-6">
            <input 
              type="text" 
              x-model="lookupTermInput"
              @keyup.enter="lookupTerm(lookupTermInput)"
              placeholder="è¼¸å…¥ term (ä¾‹å¦‚: amygdala)"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600 focus:border-transparent">
            
            <button 
              @click="lookupTerm(lookupTermInput)"
              :disabled="loading || !lookupTermInput"
              class="bg-slate-500 hover:bg-slate-600 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
              <i class="fas" :class="loading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
              <span>æŸ¥è©¢</span>
            </button>
          </div>
          
          <!-- Results -->
          <div x-show="error" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span x-text="error"></span>
          </div>
          
          <!-- Loading Skeleton for Lookup -->
          <div x-show="loading && activeTab === 'lookup'" class="space-y-3">
            <div class="skeleton h-8 w-48 rounded"></div>
            <div class="skeleton h-64 rounded-lg"></div>
          </div>
          
          <div x-show="lookupResult && !loading" class="space-y-4">
            <!-- Summary Card -->
            <div class="bg-grey-100 border border-grey-200 rounded-lg p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-lg text-yellow-700 mb-1">ç›¸é—œ Terms</h3>
                  <p class="text-sm text-gray-600">æŸ¥è©¢: <code class="bg-white px-2 py-1 rounded" x-text="lookupTermInput"></code></p>
                </div>
                <div class="text-right">
                  <p class="text-3xl font-bold text-yellow-600" x-text="lookupResult?.related?.length || 0"></p>
                  <p class="text-xs text-gray-600">å€‹ç›¸é—œ terms</p>
                </div>
              </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
              <!-- Stats & Controls -->
              <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b text-sm text-gray-600 flex-wrap gap-2">
                <p>
                  é¡¯ç¤ºç¬¬ <span class="font-bold text-yellow-600" x-text="(lookupCurrentPage - 1) * lookupItemsPerPage + 1"></span> 
                  åˆ° <span class="font-bold text-yellow-600" x-text="Math.min(lookupCurrentPage * lookupItemsPerPage, sortedLookupResults.length)"></span> 
                  ç­†ï¼Œå…± <span class="font-bold text-yellow-600" x-text="sortedLookupResults.length"></span> ç­†
                </p>
                <div class="flex items-center space-x-4">
                  <!-- Sort By -->
                  <div class="flex items-center space-x-2">
                    <label>æ’åº:</label>
                    <select x-model="lookupSortBy" @change="lookupCurrentPage = 1" class="border border-gray-300 rounded px-2 py-1 text-sm">
                      <option value="co_count">Cocount Count</option>
                      <option value="jaccard">Jaccard Index</option>
                    </select>
                  </div>
                  <!-- Items per page -->
                  <div class="flex items-center space-x-2">
                    <label>æ¯é :</label>
                    <select x-model.number="lookupItemsPerPage" @change="lookupCurrentPage = 1" class="border border-gray-300 rounded px-2 py-1 text-sm">
                      <option value="10">10</option>
                      <option value="25">25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gradient-to-r from-gray-400 to-gray-400 text-white">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold">#</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold">Related Term</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold cursor-pointer hover:bg-yellow-800" @click="toggleLookupSort('co_count')">
                        <div class="flex items-center justify-center space-x-1">
                          <span>Co-occurrence Count</span>
                          <i class="fas" :class="lookupSortBy === 'co_count' ? 'fa-sort-down' : 'fa-sort'" x-show="lookupSortBy === 'co_count' || true"></i>
                        </div>
                      </th>
                      <th class="px-4 py-3 text-center text-sm font-semibold cursor-pointer hover:bg-yellow-800" @click="toggleLookupSort('jaccard')">
                        <div class="flex items-center justify-center space-x-1">
                          <span>Jaccard Index</span>
                          <i class="fas" :class="lookupSortBy === 'jaccard' ? 'fa-sort-down' : 'fa-sort'" x-show="lookupSortBy === 'jaccard' || true"></i>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    <template x-for="(item, index) in paginatedLookupResults" :key="item.term + index">
                      <tr class="hover:bg-yellow-50 transition-colors">
                        <td class="px-4 py-3 text-sm text-gray-600 font-medium" x-text="(lookupCurrentPage - 1) * lookupItemsPerPage + index + 1"></td>
                        <td class="px-4 py-3">
                          <button @click="lookupTerm(item.term)" class="text-sm font-medium text-yellow-600 hover:text-yellow-800 hover:underline" x-text="item.term"></button>
                        </td>
                        <td class="px-4 py-3 text-center">
                          <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold" x-text="item.co_count"></span>
                        </td>
                        <td class="px-4 py-3 text-center">
                          <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold" x-text="item.jaccard.toFixed(4)"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>

              <!-- Empty State -->
              <div x-show="!lookupResult?.related || lookupResult.related.length === 0" class="text-center py-12 text-gray-500">
                <i class="fas fa-search text-6xl mb-4 text-gray-300"></i>
                <p class="text-lg font-medium">æ²’æœ‰æ‰¾åˆ°ç›¸é—œ terms</p>
              </div>
            </div>

            <!-- Pagination Controls -->
            <div class="flex items-center justify-center space-x-2" x-show="lookupTotalPages > 1">
              <button @click="lookupCurrentPage = 1" :disabled="lookupCurrentPage === 1" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-double-left"></i>
              </button>
              <button @click="lookupCurrentPage--" :disabled="lookupCurrentPage === 1" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-left"></i>
              </button>
              <template x-for="page in lookupPageNumbers" :key="page">
                <button @click="lookupCurrentPage = page" :class="lookupCurrentPage === page ? 'bg-yellow-600 text-white' : 'bg-white hover:bg-gray-100'" class="px-4 py-2 rounded-lg border border-gray-300 transition-colors font-medium" x-text="page"></button>
              </template>
              <button @click="lookupCurrentPage++" :disabled="lookupCurrentPage === lookupTotalPages" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-right"></i>
              </button>
              <button @click="lookupCurrentPage = lookupTotalPages" :disabled="lookupCurrentPage === lookupTotalPages" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-double-right"></i>
              </button>
            </div>

            <!-- Export & Debug Options -->
            <div class="flex items-center justify-between">
              <button @click="exportLookupToCSV()" class="flex items-center space-x-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                <i class="fas fa-download"></i>
                <span>åŒ¯å‡º CSV</span>
              </button>
              
              <button @click="showLookupJSON = !showLookupJSON" class="flex items-center space-x-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="fas" :class="showLookupJSON ? 'fa-eye-slash' : 'fa-eye'"></i>
                <span x-text="showLookupJSON ? 'éš±è— JSON' : 'é¡¯ç¤º JSON'"></span>
              </button>
            </div>

            <!-- Raw JSON (collapsible) -->
            <div x-show="showLookupJSON" x-collapse class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <h4 class="font-bold text-gray-700 mb-2 flex items-center">
                <i class="fas fa-code mr-2"></i>
                åŸå§‹ JSON è³‡æ–™
              </h4>
              <pre class="bg-white p-4 rounded border border-gray-300 overflow-x-auto text-xs" x-text="JSON.stringify(lookupResult, null, 2)"></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 3: Query Search -->
      <div x-show="activeTab === 'query'" x-cloak class="slide-in">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-project-diagram mr-2 text-yellow-600"></i>
            é‚è¼¯æœå°‹ Studies
          </h2>

          <!-- Syntax Help -->
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-4">
            <h4 class="font-bold text-slate-800 mb-2">ğŸ’¡ æŸ¥è©¢èªæ³•èªªæ˜</h4>
            <ul class="text-sm text-slate-700 space-y-1">
              <li>â€¢ å¯è¼¸å…¥æ¢ä»¶ï¼š<code class="bg-white px-2 py-0.5 rounded">and</code>, <code class="bg-white px-2 py-0.5 rounded">or</code>, <code class="bg-white px-2 py-0.5 rounded">not</code>
              <li>â€¢ ç¯„ä¾‹: <code class="bg-white px-2 py-0.5 rounded">amygdala and memory not emotion</code></li>
            </ul>
          </div>
          <!-- Query Builder -->
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-6 mb-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center">
              <i class="fas fa-cubes mr-2"></i>
              è¼¸å…¥æŸ¥è©¢æ¢ä»¶
            </h3>
            
            <!-- Query Conditions -->
            <div class="space-y-3 mb-4">
              <template x-for="(condition, index) in queryConditions" :key="index">
                <div class="flex items-center space-x-2">
                  <!-- Operator (for subsequent conditions) -->
                  <select x-show="index > 0" x-model="condition.operator" class="border border-gray-300 rounded px-3 py-2 text-sm font-medium w-24">
                    <option value="and">AND</option>
                    <option value="or">OR</option>
                  </select>
                  
                  <!-- NOT checkbox -->
                  <label class="flex items-center space-x-1 cursor-pointer">
                    <input type="checkbox" x-model="condition.not" class="rounded">
                    <span class="text-sm font-medium" :class="condition.not ? 'text-red-600' : 'text-gray-600'">NOT</span>
                  </label>
                  
                  <!-- Term input -->
                  <input 
                    type="text" 
                    x-model="condition.term" 
                    placeholder="è¼¸å…¥ term..."
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-600">
                  
                  <!-- Remove button -->
                  <button 
                    @click="removeCondition(index)" 
                    :disabled="queryConditions.length === 1"
                    class="px-3 py-2 bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white rounded-lg transition-colors">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </template>
            </div>
            
            <!-- Add Condition Button -->
            <button 
              @click="addCondition()"
              class="w-full py-2 border-2 border-dashed border-gray-300 hover:border-yellow-400 text-gray-600 hover:text-yellow-600 rounded-lg transition-colors flex items-center justify-center space-x-2">
              <i class="fas fa-plus"></i>
              <span>æ–°å¢æ¢ä»¶</span>
            </button>
            
            <!-- Generated Query Preview -->
            <div class="mt-4 p-4 bg-white border border-gray-300 rounded-lg">
              <p class="text-xs text-gray-500 mb-1">æŸ¥è©¢èªå¥é è¦½:</p>
              <code class="text-sm font-mono text-yellow-700" x-text="generatedQuery || '(ç©ºç™½æŸ¥è©¢)'"></code>
            </div>
          </div>
          

          
          <!-- Search Button for Builder -->
          <div class="flex justify-center mb-6">
            <button 
              @click="searchQuery(generatedQuery)"
              :disabled="loading || !generatedQuery"
              class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-8 py-3 rounded-lg transition-colors duration-200 flex items-center space-x-2 text-lg font-semibold shadow-lg">
              <i class="fas" :class="loading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
              <span>åŸ·è¡ŒæŸ¥è©¢</span>
            </button>
          </div>
          
          <!-- Results -->
          <div x-show="error" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span x-text="error"></span>
          </div>
          
          <!-- Loading Skeleton for Query -->
          <div x-show="loading && activeTab === 'query'" class="space-y-3">
            <div class="skeleton h-8 w-64 rounded"></div>
            <div class="skeleton h-96 rounded-lg"></div>
          </div>
          
          <div x-show="queryResult && !loading" class="space-y-4">
            <!-- Summary Card -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-lg text-green-800 mb-1">æœå°‹çµæœ</h3>
                  <p class="text-sm text-gray-600">æŸ¥è©¢: <code class="bg-white px-2 py-1 rounded" x-text="lastSearchedQuery"></code></p>
                </div>
                <div class="text-right">
                  <p class="text-3xl font-bold text-green-600" x-text="queryResult?.count || 0"></p>
                  <p class="text-xs text-gray-600">ç­†çµæœ</p>
                </div>
              </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
              <!-- Stats -->
              <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b text-sm text-gray-600">
                <p>
                  é¡¯ç¤ºç¬¬ <span class="font-bold text-green-600" x-text="(queryCurrentPage - 1) * queryItemsPerPage + 1"></span> 
                  åˆ° <span class="font-bold text-green-600" x-text="Math.min(queryCurrentPage * queryItemsPerPage, queryResult?.results?.length || 0)"></span> 
                  ç­†ï¼Œå…± <span class="font-bold text-green-600" x-text="queryResult?.results?.length || 0"></span> ç­†
                </p>
                <div class="flex items-center space-x-2">
                  <label>æ¯é :</label>
                  <select x-model.number="queryItemsPerPage" @change="queryCurrentPage = 1" class="border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gradient-to-r from-green-600 to-green-700 text-white">
                    <tr>
                      <th class="px-4 py-3 text-left text-sm font-semibold">#</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold">Title</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold">Authors</th>
                      <th class="px-4 py-3 text-left text-sm font-semibold">Journal</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold">Year</th>
                      <th class="px-4 py-3 text-center text-sm font-semibold">Study ID</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    <template x-for="(result, index) in paginatedQueryResults" :key="result.id">
                      <tr class="hover:bg-green-50 transition-colors">
                        <td class="px-4 py-3 text-sm text-gray-600 font-medium" x-text="(queryCurrentPage - 1) * queryItemsPerPage + index + 1"></td>
                        <td class="px-4 py-3"><p class="text-sm font-medium text-gray-900 line-clamp-2" x-text="result.title"></p></td>
                        <td class="px-4 py-3"><p class="text-sm text-gray-700" x-text="result.authors"></p></td>
                        <td class="px-4 py-3"><p class="text-xs text-gray-600 line-clamp-2" x-text="result.journal"></p></td>
                        <td class="px-4 py-3 text-center"><span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold" x-text="result.year"></span></td>
                        <td class="px-4 py-3 text-center"><code class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-700" x-text="result.study_id"></code></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>

              <!-- Empty State -->
              <div x-show="!queryResult?.results || queryResult.results.length === 0" class="text-center py-12 text-gray-500">
                <i class="fas fa-search text-6xl mb-4 text-gray-300"></i>
                <p class="text-lg font-medium">æ²’æœ‰æ‰¾åˆ°çµæœ</p>
                <p class="text-sm">è«‹å˜—è©¦ä¸åŒçš„æŸ¥è©¢æ¢ä»¶</p>
              </div>
            </div>

            <!-- Pagination Controls -->
            <div class="flex items-center justify-center space-x-2" x-show="queryTotalPages > 1">
              <button @click="queryCurrentPage = 1" :disabled="queryCurrentPage === 1" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-double-left"></i>
              </button>
              <button @click="queryCurrentPage--" :disabled="queryCurrentPage === 1" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-left"></i>
              </button>
              <template x-for="page in queryPageNumbers" :key="page">
                <button @click="queryCurrentPage = page" :class="queryCurrentPage === page ? 'bg-green-600 text-white' : 'bg-white hover:bg-gray-100'" class="px-4 py-2 rounded-lg border border-gray-300 transition-colors font-medium" x-text="page"></button>
              </template>
              <button @click="queryCurrentPage++" :disabled="queryCurrentPage === queryTotalPages" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-right"></i>
              </button>
              <button @click="queryCurrentPage = queryTotalPages" :disabled="queryCurrentPage === queryTotalPages" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-angle-double-right"></i>
              </button>
            </div>

            <!-- Export & Debug Options -->
            <div class="flex items-center justify-between">
              <button @click="exportQueryToCSV()" class="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-download"></i>
                <span>åŒ¯å‡º CSV</span>
              </button>
              
              <button @click="showRawJSON = !showRawJSON" class="flex items-center space-x-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="fas" :class="showRawJSON ? 'fa-eye-slash' : 'fa-eye'"></i>
                <span x-text="showRawJSON ? 'éš±è— JSON' : 'é¡¯ç¤º JSON'"></span>
              </button>
            </div>

            <!-- Raw JSON (collapsible) -->
            <div x-show="showRawJSON" x-collapse class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <h4 class="font-bold text-gray-700 mb-2 flex items-center">
                <i class="fas fa-code mr-2"></i>
                åŸå§‹ JSON è³‡æ–™
              </h4>
              <pre class="bg-white p-4 rounded border border-gray-300 overflow-x-auto text-xs" x-text="JSON.stringify(queryResult, null, 2)"></pre>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white mt-12 py-6">
    <div class="container mx-auto px-4 text-center">
      <p class="text-gray-400">
        <i class="fas fa-code mr-2"></i>
        Built with Tailwind CSS + Alpine.js | Data from Neurosynth API
      </p>
      <p class="text-gray-500 text-sm mt-2">
        NTU Psychology Lab | 2025
      </p>
    </div>
  </footer>

  <!-- Alpine.js App Logic -->
  <script>
    function neurosynthApp() {
      return {
        // API Base URL
        apiBase: 'https://hpc.psy.ntu.edu.tw:5000',
        
        // State
        activeTab: 'terms',
        loading: false,
        error: null,
        
        // Data
        allTerms: [],
        termFilter: '',
        lookupTermInput: '',
        lookupResult: null,
        queryInput: '',
        queryResult: null,
        showRawJSON: false,
        showLookupJSON: false,
        lastSearchedQuery: '',
        
        // Query Builder
        queryConditions: [
          { operator: 'and', term: '', not: false }
        ],
        
        // Pagination for Terms List
        currentPage: 1,
        itemsPerPage: 24,
        jumpToPage: 1,
        
        // Pagination for Lookup
        lookupCurrentPage: 1,
        lookupItemsPerPage: 25,
        lookupSortBy: 'co_count',
        
        // Pagination for Query
        queryCurrentPage: 1,
        queryItemsPerPage: 25,
        
        // Computed - Generated Query
        get generatedQuery() {
          if (!this.queryConditions || this.queryConditions.length === 0) return '';
          
          let query = '';
          this.queryConditions.forEach((condition, index) => {
            if (!condition.term.trim()) return;
            
            if (index > 0) {
              query += ' ' + condition.operator + ' ';
            }
            
            if (condition.not) {
              query += 'not ';
            }
            
            query += condition.term.trim();
          });
          
          return query.trim();
        },
        
        // Computed - Filtered Terms
        get filteredTerms() {
          if (!this.termFilter) return this.allTerms;
          const filter = this.termFilter.toLowerCase();
          return this.allTerms.filter(term => 
            term.toLowerCase().includes(filter)
          );
        },
        
        // Computed - Total Pages for Terms
        get totalPages() {
          return Math.ceil(this.filteredTerms.length / this.itemsPerPage);
        },
        
        // Computed - Paginated Terms
        get paginatedTerms() {
          const start = (this.currentPage - 1) * this.itemsPerPage;
          const end = start + this.itemsPerPage;
          return this.filteredTerms.slice(start, end);
        },
        
        // Computed - Page Numbers for Terms
        get pageNumbers() {
          const pages = [];
          const total = this.totalPages;
          const current = this.currentPage;
          
          if (total <= 7) {
            for (let i = 1; i <= total; i++) pages.push(i);
          } else {
            pages.push(1);
            if (current > 3) pages.push('...');
            for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) pages.push(i);
            if (current < total - 2) pages.push('...');
            pages.push(total);
          }
          return pages;
        },
        
        // Computed - Lookup Pagination
        get sortedLookupResults() {
          if (!this.lookupResult?.related) return [];
          const results = [...this.lookupResult.related];
          return results.sort((a, b) => b[this.lookupSortBy] - a[this.lookupSortBy]);
        },
        
        get lookupTotalPages() {
          return Math.ceil(this.sortedLookupResults.length / this.lookupItemsPerPage);
        },
        
        get paginatedLookupResults() {
          const start = (this.lookupCurrentPage - 1) * this.lookupItemsPerPage;
          const end = start + this.lookupItemsPerPage;
          return this.sortedLookupResults.slice(start, end);
        },
        
        get lookupPageNumbers() {
          const pages = [];
          const total = this.lookupTotalPages;
          const current = this.lookupCurrentPage;
          
          if (total <= 7) {
            for (let i = 1; i <= total; i++) pages.push(i);
          } else {
            pages.push(1);
            if (current > 3) pages.push('...');
            for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) pages.push(i);
            if (current < total - 2) pages.push('...');
            pages.push(total);
          }
          return pages;
        },
        
        // Computed - Query Pagination
        get queryTotalPages() {
          return Math.ceil((this.queryResult?.results?.length || 0) / this.queryItemsPerPage);
        },
        
        get paginatedQueryResults() {
          if (!this.queryResult?.results) return [];
          const start = (this.queryCurrentPage - 1) * this.queryItemsPerPage;
          const end = start + this.queryItemsPerPage;
          return this.queryResult.results.slice(start, end);
        },
        
        get queryPageNumbers() {
          const pages = [];
          const total = this.queryTotalPages;
          const current = this.queryCurrentPage;
          
          if (total <= 7) {
            for (let i = 1; i <= total; i++) pages.push(i);
          } else {
            pages.push(1);
            if (current > 3) pages.push('...');
            for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) pages.push(i);
            if (current < total - 2) pages.push('...');
            pages.push(total);
          }
          return pages;
        },
        
        // Methods - Query Builder
        addCondition() {
          this.queryConditions.push({
            operator: 'and',
            term: '',
            not: false
          });
        },
        
        removeCondition(index) {
          if (this.queryConditions.length > 1) {
            this.queryConditions.splice(index, 1);
          }
        },
        
        // Methods
        async fetchAllTerms() {
          this.loading = true;
          this.error = null;
          
          try {
            const response = await fetch(`${this.apiBase}/terms`);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (Array.isArray(data)) {
              this.allTerms = data;
            } else if (data.terms && Array.isArray(data.terms)) {
              this.allTerms = data.terms;
            } else {
              this.allTerms = Object.keys(data);
            }
            
            this.currentPage = 1;
            console.log('Fetched terms:', this.allTerms.length);
          } catch (err) {
            this.error = `è¼‰å…¥å¤±æ•—: ${err.message}`;
            console.error('Error:', err);
          } finally {
            this.loading = false;
          }
        },
        
        async lookupTerm(term) {
          if (!term || !term.trim()) return;
          
          this.activeTab = 'lookup';
          this.lookupTermInput = term;
          this.loading = true;
          this.error = null;
          this.lookupResult = null;
          this.lookupCurrentPage = 1;
          
          try {
            const encodedTerm = encodeURIComponent(term.trim());
            const response = await fetch(`${this.apiBase}/terms/${encodedTerm}`);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            this.lookupResult = data;
            
            console.log('Lookup result:', data);
          } catch (err) {
            this.error = `æŸ¥è©¢å¤±æ•—: ${err.message}`;
            console.error('Error:', err);
          } finally {
            this.loading = false;
          }
        },
        
        async searchQuery(query) {
          if (!query || !query.trim()) return;
          
          this.loading = true;
          this.error = null;
          this.queryResult = null;
          this.queryCurrentPage = 1;
          this.lastSearchedQuery = query;
          
          try {
            const encodedQuery = encodeURIComponent(query.trim());
            const response = await fetch(`${this.apiBase}/query/${encodedQuery}/studies`);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            this.queryResult = data;
            
            console.log('Query result:', data);
          } catch (err) {
            this.error = `æœå°‹å¤±æ•—: ${err.message}`;
            console.error('Error:', err);
          } finally {
            this.loading = false;
          }
        },
        
        goToPage() {
          if (this.jumpToPage >= 1 && this.jumpToPage <= this.totalPages) {
            this.currentPage = this.jumpToPage;
          }
        },
        
        toggleLookupSort(field) {
          this.lookupSortBy = field;
          this.lookupCurrentPage = 1;
        },
        
        exportLookupToCSV() {
          if (!this.lookupResult || !this.lookupResult.related) {
            alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
            return;
          }
          
          const results = this.sortedLookupResults;
          const headers = ['#', 'Related Term', 'Co-occurrence Count', 'Jaccard Index'];
          const csvRows = [headers.join(',')];
          
          results.forEach((result, index) => {
            const row = [
              index + 1,
              `"${(result.term || '').replace(/"/g, '""')}"`,
              result.co_count || 0,
              result.jaccard || 0
            ];
            csvRows.push(row.join(','));
          });
          
          const csvContent = csvRows.join('\n');
          const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          
          const filename = `neurosynth_related_${this.lookupTermInput.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
          
          link.setAttribute('href', url);
          link.setAttribute('download', filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
        
        exportQueryToCSV() {
          if (!this.queryResult || !this.queryResult.results) {
            alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
            return;
          }
          
          const results = this.queryResult.results;
          const headers = ['#', 'Title', 'Authors', 'Journal', 'Year', 'Study ID'];
          const csvRows = [headers.join(',')];
          
          results.forEach((result, index) => {
            const row = [
              index + 1,
              `"${(result.title || '').replace(/"/g, '""')}"`,
              `"${(result.authors || '').replace(/"/g, '""')}"`,
              `"${(result.journal || '').replace(/"/g, '""')}"`,
              result.year || '',
              result.study_id || ''
            ];
            csvRows.push(row.join(','));
          });
          
          const csvContent = csvRows.join('\n');
          const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          
          const filename = `neurosynth_query_${this.lastSearchedQuery.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
          
          link.setAttribute('href', url);
          link.setAttribute('download', filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
        
        // Initialize
        init() {
          console.log('Neurosynth Explorer initialized');
          this.fetchAllTerms();
        }
      }
    }
  </script>
</body>
</html>